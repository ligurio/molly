<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Molly documentation</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>molly</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Functions">Functions</a></li>
</ul>


<h2>Modules</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../modules/molly.tests.html">molly.tests</a></li>
  <li><strong>molly.runner</strong></li>
  <li><a href="../modules/molly.history.html">molly.history</a></li>
  <li><a href="../modules/molly.utils.html">molly.utils</a></li>
  <li><a href="../modules/molly.op.html">molly.op</a></li>
  <li><a href="../modules/molly.gen.html">molly.gen</a></li>
  <li><a href="../modules/molly.client.html">molly.client</a></li>
  <li><a href="../modules/molly.html">molly</a></li>
  <li><a href="../modules/molly.db.html">molly.db</a></li>
  <li><a href="../modules/molly.thread_fiber.html">molly.thread_fiber</a></li>
  <li><a href="../modules/molly.thread_coroutine.html">molly.thread_coroutine</a></li>
  <li><a href="../modules/molly.nemesis.html">molly.nemesis</a></li>
  <li><a href="../modules/molly.thread.html">molly.thread</a></li>
  <li><a href="../modules/molly.log.html">molly.log</a></li>
</ul>
<h2>Topics</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../topics/README.md.html">README</a></li>
</ul>
<h2>Examples</h2>
<ul class="$(kind=='Topics' and '' or 'nowrap'">
  <li><a href="../examples/sqlite-rw-register.lua.html">sqlite-rw-register.lua</a></li>
  <li><a href="../examples/sqlite-list-append.lua.html">sqlite-list-append.lua</a></li>
</ul>

</div>

<div id="content">

<h1>Module <code>molly.runner</code></h1>
<p>Module with main functions that runs tests.</p>
<p>


<h3>Design Overview</h3>

<p> A Molly test runs as a Lua program on a control node. That program may use
 remote access to log into a bunch of DB nodes, where it sets up the
 distributed system you're going to test or use local DB instances.</p>

<p>``<code></p>
<pre><code>         +-------------+
+------- | controller  | -------+
|        +-------------+        |
|          |    |    |          |
|     +----+    |    |          |
v     v         |    |          v
</code></pre>
<p>  +----+----+----+  |    |  +----+----+
  | n1 | n2 | n3 | &lt;+    +> | n4 | n5 |
  +----+----+----+          +----+----+
</code>`<code></p>

<p> Once the system is running, the control node spins up a set of logically
 single-threaded processes (see </code>molly.thread<code>), each with its own client for
 the distributed system.</p>

<p> A generator (see </code>molly.gen<code>) generates new operations (see </code>molly.op<code>)
 for each process to perform. Processes then apply those operations to the
 system using their clients, see </code>molly.client<code>. The start and end of each
 operation is recorded in a history, see </code>molly.history<code>. While performing
 operations, a special nemesis process (see </code>molly.nemesis<code>) introduces
 faults into the system - also scheduled by the generator.</p>

<p> Finally, the DB is turn down. Molly uses a checker (see </code>molly.checker<code>)
 to analyze the test's history for correctness, and to generate reports,
 graphs, etc. The test, history, analysis, and any supplementary results are
 written to the filesystem for later review.</p>

<p> <!-- TODO: https://jepsen.io/consistency --></p>

<h3>Performance Tips</h3>

<p> <strong>Disable debug mode</strong>: by default tests enables type checking, see
 statements with </code>dev_checks()<code> in source code, and code coverage gathering.
 This requires using Lua </code>debug<code> module, that can significantly slowdown of
 execution (about 1.6 times). You can control it with environment variable
 </code>DEV<code>, to run tests with disabled type checking and code coverage: </code>DEV=OFF
 make test<code>.</p>

<p> <strong>Disable verbose mode</strong>: see description of </code>verbose` mode.</p>

<p> <strong>Use fibers</strong>: TODO: performance of fibers vs coroutines.</p>
</p>


<h2><a href="#Functions">Functions</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#run_test">run_test (workload, opts)</a></td>
	<td class="summary">Create test and run.</td>
	</tr>
</table>

<br/>
<br/>


    <h2><a name="Functions"></a>Functions</h2>
    <dl class="function">
    <dt>
    <a name = "run_test"></a>
    <strong>run_test (workload, opts)</strong>
    </dt>
    <dd>
    Create test and run.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">workload</span> Table with workload options.
        <ul>
        <li><span class="parameter">client</span>
         Workload client. Learn more about creating clients in
 <a href="../modules/molly.client.html#">molly.client</a> .
        </li>
        <li><span class="parameter">generator</span>
            <span class="types"><a class="type" href="http://www.lua.org/manual/5.1/manual.html#5.5">table</a></span>
         Generator of operations used in test workload.
 Generator must be a table with <code>unwrap()</code> method that returns an iterator
 triplet. You can make generator youself or use <a href="../modules/molly.gen.html#">molly.gen</a>  module.
        </li>
        <li><span class="parameter">checker</span>
         Function for checking history in workload.
        </li>
        </li></ul>
        <li><span class="parameter">opts</span> Table with test options.
        <ul>
        <li><span class="parameter">create_reports</span>
            <span class="types"><span class="type">boolean</span></span>

<p> Option to control creating reports,
 disabled by default. When enabled a number of files created:</p>

<ul>
    <li>history.txt with plain history;</li>
    <li>history.json with history encoded to JSON;</li>
</ul>


        </li>
        <li><span class="parameter">threads</span>
            <span class="types"><span class="type">number</span></span>
         Number of threads in a test workload, default
 value is 1.
        </li>
        <li><span class="parameter">verbose</span>
            <span class="types"><span class="type">boolean</span></span>
         shows details about the results and progress of
 running test. This can be especially useful when the results might not be
 obvious. For example, if you want to see the progress of testing as it
 setup, teardown or invokes operations, you can use the 'verbose' option. In
 the beginning, you may find it useful to use 'verbose' at all times; when
 you are more accustomed to <a href="../modules/molly.html#">molly</a> , you will likely want to use it at
 certain times but not at others. Disabled by default.
 Take into account that logging to standart output is a slow operation and
 with enabled verbose mode <a href="../modules/molly.html#">molly</a>  logs status of every operation before
 and after it's invocation and this may slowdown overall testing performance
 significantly. It is recommended to disable verbose mode in a final testing
 and use it only for debugging.
        </li>
        <li><span class="parameter">thread_type</span>
            <span class="types"><a class="type" href="http://www.lua.org/manual/5.1/manual.html#5.4">string</a></span>
         Type of threads used in a test workload.
 Possible values are 'fiber' (see <a href="../modules/molly.thread_fiber.html#">molly.thread_fiber</a> ) and 'coroutine' (see
 <a href="../modules/molly.thread_coroutine.html#">molly.thread_coroutine</a> ), default value is 'fiber' on Tarantool and
 'coroutine' on LuaJIT. Learn more about possible thread types in
 <a href="../modules/molly.thread.html#">molly.thread</a> .
        </li>
        <li><span class="parameter">time_limit</span>
            <span class="types"><span class="type">number</span></span>
         Number of seconds to limit time of testing. By
 default testing time is endless and limited by a number of operations
 produced by generator.
        </li>
        <li><span class="parameter">nodes</span>
            <span class="types"><a class="type" href="http://www.lua.org/manual/5.1/manual.html#5.5">table</a></span>
         A table that contains IP addresses of nodes
 participated in testing.
        </li>
        </li></ul>
    </ul>

    <h3>Returns:</h3>
    <ol>

        true on success or nil with error
    </ol>


    <h3>See also:</h3>
    <ul>
         <li><a href="../modules/molly.gen.html#">molly.gen</a></li>
         <li><a href="../modules/molly.client.html#">molly.client</a></li>
    </ul>

    <h3>Usage:</h3>
    <ul>
        <pre class="example">

 <span class="keyword">local</span> test_options = {
     create_reports = <span class="keyword">true</span>,
     thread_type = <span class="string">'fiber'</span>,
     threads = <span class="number">5</span>,
     nodes = {
         <span class="string">'127.0.0.1'</span>
     }
 }
 <span class="keyword">local</span> ok, err = runner.run_test({
     client = client.new(),
     generator = gen_lib.cycle(gen_lib.iter({ r, w })):take(<span class="number">1000</span>)
 }, test_options)</pre>
    </ul>

</dd>
</dl>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.2</a></i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
